local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local npcFolder = Workspace:WaitForChild("NPCs", 10)
local mazeFolder = Workspace:WaitForChild("Maze", 10)
local pim = npcFolder:WaitForChild("Pim", 10)

local espEnabled = false

-- ====================== GUI ======================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPInfoGUI"
screenGui.Parent = playerGui

local infoLabel = Instance.new("TextLabel")
infoLabel.Size = UDim2.new(0,300,0,50)
infoLabel.Position = UDim2.new(0,20,0,20)
infoLabel.BackgroundTransparency = 0.5
infoLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
infoLabel.TextColor3 = Color3.fromRGB(255,255,255)
infoLabel.TextScaled = true
infoLabel.Text = "กด E เพื่อเปิด ESP (OFF)"
infoLabel.Parent = screenGui

local function updateGUILabel()
	infoLabel.Text = string.format("กด E เพื่อเปิด ESP (%s)", espEnabled and "ON" or "OFF")
end

-- ====================== Fog/Atmosphere ======================
local originalFogStart = Lighting.FogStart
local originalFogEnd = Lighting.FogEnd
local originalGlobalShadows = Lighting.GlobalShadows

local originalAtmosphere = Lighting:FindFirstChild("Atmosphere")
local savedAtmosphereClone
if originalAtmosphere then
	savedAtmosphereClone = originalAtmosphere:Clone()
end

-- ====================== Helper ======================
local function createESP(target, nameText, color)
	if not target or not target.Parent then return nil end

	local hl = Instance.new("Highlight")
	hl.Name = nameText .. "Highlight"
	hl.FillColor = color
	hl.FillTransparency = 1
	hl.OutlineColor = color
	hl.Parent = target
	TweenService:Create(hl, TweenInfo.new(1), {FillTransparency = 0.7}):Play()

	local bb = Instance.new("BillboardGui")
	bb.Name = nameText .. "ESP"
	bb.Size = UDim2.new(0,140,0,40)
	bb.AlwaysOnTop = true
	bb.StudsOffset = Vector3.new(0,4,0)
	bb.Parent = target

	local text = Instance.new("TextLabel")
	text.Size = UDim2.new(1,0,1,0)
	text.BackgroundTransparency = 1
	text.TextColor3 = color
	text.TextScaled = true
	text.Parent = bb

	local updateConn
	updateConn = RunService.RenderStepped:Connect(function()
		if not target.Parent or not bb.Parent then
			updateConn:Disconnect()
			return
		end
		local humanoidRootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if humanoidRootPart then
			local distance = (humanoidRootPart.Position - target:GetPivot().Position).Magnitude
			text.Text = string.format("%s | %.1f studs", nameText, distance)
		end
	end)

	return {highlight = hl, billboard = bb, updateConn = updateConn}
end

-- ====================== ESP Objects ======================
local pimESP
local scaretrapsESP = {}
local mazeTransitionESP
local npcsESP = {}

local function addAllESP()
	if pim and pim.Parent then
		pimESP = createESP(pim, "ไอเป็ด", Color3.fromRGB(255,0,0))
	end

	-- Scaretraps และ NPCs
	for _, npc in ipairs(npcFolder:GetChildren()) do
		if npc.Name == "Scaretrap" then
			table.insert(scaretrapsESP, createESP(npc, "หัวฟักทอง", Color3.fromRGB(255,175,0)))
		elseif npc ~= pim then
			table.insert(npcsESP, createESP(npc, npc.Name, Color3.fromRGB(255,255,0)))
		end
	end

	-- ติดตาม NPC ใหม่อัตโนมัติ
	npcFolder.ChildAdded:Connect(function(child)
		if espEnabled then
			if child.Name == "Scaretrap" then
				table.insert(scaretrapsESP, createESP(child, "หัวฟักทอง", Color3.fromRGB(255,175,0)))
			elseif child ~= pim then
				table.insert(npcsESP, createESP(child, child.Name, Color3.fromRGB(255,255,0)))
			end
		end
	end)
end

local function removeAllESP()
	if pimESP then
		if pimESP.updateConn then pimESP.updateConn:Disconnect() end
		if pimESP.highlight then pimESP.highlight:Destroy() end
		if pimESP.billboard then pimESP.billboard:Destroy() end
		pimESP = nil
	end

	for _, esp in ipairs(scaretrapsESP) do
		if esp.updateConn then esp.updateConn:Disconnect() end
		if esp.highlight then esp.highlight:Destroy() end
		if esp.billboard then esp.billboard:Destroy() end
	end
	scaretrapsESP = {}

	for _, esp in ipairs(npcsESP) do
		if esp.updateConn then esp.updateConn:Disconnect() end
		if esp.highlight then esp.highlight:Destroy() end
		if esp.billboard then esp.billboard:Destroy() end
	end
	npcsESP = {}

	if mazeTransitionESP then
		if mazeTransitionESP.updateConn then mazeTransitionESP.updateConn:Disconnect() end
		if mazeTransitionESP.highlight then mazeTransitionESP.highlight:Destroy() end
		if mazeTransitionESP.billboard then mazeTransitionESP.billboard:Destroy() end
		mazeTransitionESP = nil
	end
end

-- ====================== Keybind E ======================
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.E then
		espEnabled = not espEnabled
		updateGUILabel()
		if espEnabled then
			addAllESP()
			Lighting.FogStart = 0
			Lighting.FogEnd = 999999
			Lighting.GlobalShadows = false
			local atmosphere = Lighting:FindFirstChild("Atmosphere")
			if atmosphere then atmosphere:Destroy() end
		else
			removeAllESP()
			Lighting.FogStart = originalFogStart
			Lighting.FogEnd = originalFogEnd
			Lighting.GlobalShadows = originalGlobalShadows
			if savedAtmosphereClone then savedAtmosphereClone.Parent = Lighting end
		end
	end
end)

-- ====================== Persistent ESP หลัง Respawn ======================
local function onCharacterAdded(char)
	local humanoidRootPart = char:WaitForChild("HumanoidRootPart")
	if espEnabled then
		addAllESP()
	end
end

player.CharacterAdded:Connect(onCharacterAdded)
if player.Character then
	onCharacterAdded(player.Character)
end

-- ====================== Track Maze.transition แบบ Dynamic ======================
local function trackMazeTransition()
	local function addTransitionESP(transition)
		if not transition then return end
		if mazeTransitionESP and mazeTransitionESP.billboard.Parent then return end
		mazeTransitionESP = createESP(transition, "ทางออก", Color3.fromRGB(0,255,255))
	end

	-- ตรวจตอนเริ่ม
	local initialTransition = mazeFolder:FindFirstChild("transition")
	addTransitionESP(initialTransition)

	-- ติดตามสร้างใหม่ตลอดเวลา
	mazeFolder.ChildAdded:Connect(function(child)
		if espEnabled and child.Name == "transition" then
			addTransitionESP(child)
		end
	end)
end

trackMazeTransition()
